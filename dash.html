<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Itians</title>
<style>
    /* ---------- RESET & BASE ---------- */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
    body { display: flex; height: 100vh; background: #f5f6fa; }
    a { text-decoration: none; color: inherit; }
    button { cursor: pointer; }

    /* ---------- SIDEBAR ---------- */
    .sidebar { width: 250px; background: #2f3640; color: #f5f6fa; display: flex; flex-direction: column; }
    .sidebar h2 { text-align: center; padding: 1.5rem 0; background: #353b48; font-size: 1.5rem; }
    .sidebar ul { list-style: none; padding: 0; }
    .sidebar ul li { padding: 1rem 1.5rem; transition: 0.2s; }
    .sidebar ul li:hover { background: #40739e; }
    .sidebar ul li.active { background: #40739e; }
    .sidebar ul li button { all: unset; width: 100%; display: block; }

    /* ---------- MAIN ---------- */
    .main { flex: 1; padding: 1rem 2rem; overflow-y: auto; }

    /* ---------- TABLE ---------- */
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #dcdde1; padding: 0.75rem; text-align: left; }
    th { background: #40739e; color: white; }
    td button { padding: 0.3rem 0.6rem; margin-right: 0.3rem; border: none; border-radius: 5px; }
    .edit-btn { background: #fbc531; color: #2f3640; }
    .delete-btn { background: #e84118; color: white; }
    .approve-btn { background: #27ae60; color: white; }
    .reject-btn { background: #e84118; color: white; }

    /* ---------- MODALS ---------- */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10; }
    .modal-content { background: #f5f6fa; padding: 1.5rem; width: 500px; border-radius: 10px; position: relative; max-height: 90%; overflow-y: auto; }
    .modal-content h3 { margin-bottom: 1rem; }
    .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 0.5rem; margin-bottom: 0.8rem; border: 1px solid #ccc; border-radius: 5px; }
    .modal-content button { padding: 0.5rem 1rem; border: none; border-radius: 5px; background: #40739e; color: white; }
    .close { position: absolute; top: 0.5rem; right: 1rem; font-size: 1.5rem; cursor: pointer; }

    /* ---------- STATS ---------- */
    .stat-cards { display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; }
    .stat-card { flex: 1; background: #40739e; color: white; padding: 1rem; border-radius: 10px; min-width: 150px; text-align: center; }
</style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <h2>Admin Panel</h2>
    <ul>
        <li class="active"><button onclick="showSection('dashboard')">Dashboard</button></li>
        <li><button onclick="showSection('courses')">Courses</button></li>
        <li><button onclick="showSection('categories')">Categories</button></li>
        <li><button onclick="showSection('students')">Students</button></li>
   <li><button onclick="logout()">Logout</button></li>    
    </ul>
</div>

<!-- MAIN -->
<div class="main">

    <!-- DASHBOARD -->
    <div id="dashboard" class="section">
        <h2>Dashboard</h2>
        <div class="stat-cards">
            <div class="stat-card" id="totalCourses">Courses: 0</div>
            <div class="stat-card" id="totalCategories">Categories: 0</div>
            <div class="stat-card" id="totalStudents">Students: 0</div>
            <div class="stat-card" id="pendingEnrollmentsCard">Pending: 0</div>
        </div>
    </div>

    <!-- COURSES -->
    <div id="courses" class="section" style="display:none;">
        <h2>Courses <button onclick="openCourseModal()">Add Course</button></h2>
        <table id="coursesTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Category</th>
                    <th>Instructor</th>
                    <th>Price</th>
                    <th>Duration</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- CATEGORIES -->
    <div id="categories" class="section" style="display:none;">
        <h2>Categories <button onclick="openCategoryModal()">Add Category</button></h2>
        <table id="categoriesTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- STUDENTS -->
    <div id="students" class="section" style="display:none;">
        <h2>Students & Pending Enrollments</h2>
        <table id="studentsTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Courses</th>
                    <th>Pending Enrollments</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<!-- COURSE MODAL -->
<div class="modal" id="courseModal">
    <div class="modal-content">
        <span class="close" onclick="closeCourseModal()">&times;</span>
        <h3>Add / Edit Course</h3>
        <input type="hidden" id="courseId">
        <input type="text" id="courseTitle" placeholder="Title">
        <input type="text" id="courseCategory" placeholder="Category">
        <input type="text" id="courseInstructor" placeholder="Instructor">
        <input type="number" id="coursePrice" placeholder="Price">
        <input type="text" id="courseDuration" placeholder="Duration">
        <textarea id="courseDescription" placeholder="Description"></textarea>
        <input type="text" id="courseImage" placeholder="Image URL">
        <button onclick="saveCourse()">Save</button>
    </div>
</div>

<!-- CATEGORY MODAL -->
<div class="modal" id="categoryModal">
    <div class="modal-content">
        <span class="close" onclick="closeCategoryModal()">&times;</span>
        <h3>Add / Edit Category</h3>
        <input type="hidden" id="categoryId">
        <input type="text" id="categoryName" placeholder="Category Name">
        <button onclick="saveCategory()">Save</button>
    </div>
</div>

<script>
/* ---------- INITIAL DATA ---------- */
let courses = JSON.parse(localStorage.getItem('courses')) || [];
let categories = JSON.parse(localStorage.getItem('categories')) || [];
let users = JSON.parse(localStorage.getItem('users')) || [];
let pendingEnrollments = JSON.parse(localStorage.getItem('pendingEnrollments')) || [];

/* ---------- SECTION SWITCHING ---------- */
function showSection(section) {
    document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
    document.getElementById(section).style.display = 'block';
    document.querySelectorAll('.sidebar ul li').forEach(li => li.classList.remove('active'));
    event.target.parentElement.classList.add('active');
    updateStats();
    renderTables();
}

/* ---------- STATS ---------- */
function updateStats() {
    document.getElementById('totalCourses').textContent = `Courses: ${courses.length}`;
    document.getElementById('totalCategories').textContent = `Categories: ${categories.length}`;
    document.getElementById('totalStudents').textContent = `Students: ${users.filter(u=>u.role==='student').length}`;
    document.getElementById('pendingEnrollmentsCard').textContent = `Pending: ${pendingEnrollments.length}`;
}

/* ---------- COURSES TABLE ---------- */
function renderCourses() {
    const tbody = document.querySelector('#coursesTable tbody');
    tbody.innerHTML = '';
    courses=JSON.parse(localStorage.getItem("courses"))
    courses.forEach(c=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${c.id}</td>
            <td>${c.title}</td>
            <td>${c.category}</td>
            <td>${c.instructor}</td>
            <td>${c.price}</td>
            <td>${c.duration}</td>
            <td>
                <button class="edit-btn" onclick="editCourse(${c.id})">Edit</button>
                <button class="delete-btn" onclick="deleteCourse(${c.id})">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

/* ---------- CATEGORIES TABLE ---------- */
function renderCategories() {
    const tbody = document.querySelector('#categoriesTable tbody');
    tbody.innerHTML = '';
    categories=JSON.parse(localStorage.getItem("categories"))
    console.log(categories)
    categories.forEach((cat, i)=>{
        var tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${cat}</td>
            <td>
                <button class="edit-btn" onclick="editCategory(${i})">Edit</button>
                <button class="delete-btn" onclick="deleteCategory(${i})">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
        //console.log(categories)

      });
}
function editCategory(index){
    let categories = JSON.parse(localStorage.getItem('categories')) || [];

    // تحقق اذا العنصر موجود
    if(index < 0 || index >= categories.length || !categories[index]){
        alert('This category does not exist!');
        return; // الخروج من الدالة
    }

    // لو موجود، فتح المودال مع تعبئة البيانات
    document.getElementById('categoryId').value = index; // حفظ index للتعديل
    document.getElementById('categoryName').value = categories[index];
    document.getElementById('categoryModal').style.display = 'flex';
    renderCategories();
    updateStats();
}
 function deleteCategory(index){
    let categories = JSON.parse(localStorage.getItem('categories')) || [];
    if(!categories[index]) return; // تأكد ان العنصر موجود
    if(confirm('Are you sure you want to delete this category?')){
      //  categories.splice(index, 1); // حذف العنصر
        categories=categories.filter((ele,ind)=>ind!=index)
        localStorage.setItem('categories', JSON.stringify(categories));
        renderCategories();
        updateStats();
    }
}
/* ---------- EDIT CATEGORY ---------- */


/* ---------- STUDENTS TABLE ---------- */
function renderStudents() {
    const tbody = document.querySelector('#studentsTable tbody');
    tbody.innerHTML = '';
    users.filter(u=>u.role==='student').forEach(u=>{
        const studentCourses = courses.filter(c=>u.courses.includes(c.id)).map(c=>c.title).join(', ');
        const pending = pendingEnrollments.filter(p=>p.userId===u.id);
        const pendingHTML = pending.map(p=>{
            const c = courses.find(c=>c.id===p.courseId);
            return `<span>${c.title} <button class="approve-btn" onclick="approveEnrollment('${u.id}',${c.id})">✓</button><button class="reject-btn" onclick="rejectEnrollment('${u.id}',${c.id})">✗</button></span>`;
        }).join('<br>') || '—';
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>${studentCourses || '—'}</td>
            <td>${pendingHTML}</td>
        `;
        tbody.appendChild(tr);
    });
}

/* ---------- RENDER ALL TABLES ---------- */
function renderTables(){
    renderCourses();
    renderCategories();
    renderStudents();
}

/* ---------- COURSE MODAL ---------- */
function openCourseModal(){
    document.getElementById('courseId').value='';
    document.getElementById('courseTitle').value='';
    document.getElementById('courseCategory').value='';
    document.getElementById('courseInstructor').value='';
    document.getElementById('coursePrice').value='';
    document.getElementById('courseDuration').value='';
    document.getElementById('courseDescription').value='';
    document.getElementById('courseImage').value='';
    document.getElementById('courseModal').style.display='flex';
}
function closeCourseModal(){ document.getElementById('courseModal').style.display='none'; }
function saveCourse() {
    const title = document.getElementById('courseTitle').value.trim();
    const category = document.getElementById('courseCategory').value.trim();
    const instructor = document.getElementById('courseInstructor').value.trim();
    const price = Number(document.getElementById('coursePrice').value);
    const duration = document.getElementById('courseDuration').value.trim();
    const description = document.getElementById('courseDescription').value.trim();
    const image = document.getElementById('courseImage').value.trim();

    if (!title || !category || !instructor) {
        alert('Please fill required fields');
        return;
    }

    let courses = JSON.parse(localStorage.getItem('courses')) || [];
    const idInput = document.getElementById('courseId').value;

    // --- Check for duplicate title (excluding the course being edited) ---
    const duplicate = courses.find(c => c.title.toLowerCase() === title.toLowerCase() && c.id != idInput);
    if (duplicate) {
        alert('A course with this title already exists!');
        return;
    }

    if (idInput) {
        // Edit existing course
        const course = courses.find(c => c.id == idInput);
        if (course) {
            Object.assign(course, { title, category, instructor, price, duration, description, image });
        }
    } else {
        // Add new course
        const newId = courses.length ? Math.max(...courses.map(c => Number(c.id) || 0)) + 1 : 1;
        const newCourse = { id: newId, title, category, instructor, price, duration, description, image, content: [], enrollRequests: [] };
        courses.push(newCourse);
    }

    localStorage.setItem('courses', JSON.stringify(courses));
    renderCourses();
    closeCourseModal();
}



/* ---------- EDIT/DELETE COURSE ---------- */
function editCourse(id){
    const c = courses.find(c=>c.id==id);
    document.getElementById('courseId').value=c.id;
    document.getElementById('courseTitle').value=c.title;
    document.getElementById('courseCategory').value=c.category;
    document.getElementById('courseInstructor').value=c.instructor;
    document.getElementById('coursePrice').value=c.price;
    document.getElementById('courseDuration').value=c.duration;
    document.getElementById('courseDescription').value=c.description;
    document.getElementById('courseImage').value=c.image;
    document.getElementById('courseModal').style.display='flex';
}
function deleteCourse(id){
    if(confirm('Delete this course?')){
        courses = courses.filter(c=>c.id!=id);
        localStorage.setItem('courses',JSON.stringify(courses));
        renderCourses();
        updateStats();
    }
}

/* ---------- CATEGORY MODAL ---------- */
function openCategoryModal(){
    document.getElementById('categoryId').value='';
    document.getElementById('categoryName').value='';
    document.getElementById('categoryModal').style.display='flex';
}
function closeCategoryModal(){ document.getElementById('categoryModal').style.display='none'; }
function saveCategory() {
    const idInput = document.getElementById('categoryId').value;
    const name = document.getElementById('categoryName').value.trim();
    if (!name) { alert('Enter category name'); return; }

    // --- Check for duplicate category (excluding the one being edited) ---
    const duplicate = categories.find((cat, i) => cat.toLowerCase() === name.toLowerCase() && i != idInput);
    if (duplicate) {
        alert('This category already exists!');
        return;
    }

    if (idInput) {
        categories[idInput] = name;
    } else {
        categories.push(name);
    }

    localStorage.setItem('categories', JSON.stringify(categories));
    closeCategoryModal();
    renderCategories();
    updateStats();
}

/* ---------- PENDING ENROLLMENTS ---------- */
function approveEnrollment(userId, courseId){
    const user = users.find(u=>u.id===userId);
    if(user && !user.courses.includes(courseId)) user.courses.push(courseId);
    pendingEnrollments = pendingEnrollments.filter(p=>!(p.userId===userId && p.courseId===courseId));
    localStorage.setItem('users',JSON.stringify(users));
    localStorage.setItem('pendingEnrollments',JSON.stringify(pendingEnrollments));
    renderStudents();
    updateStats();
}
function rejectEnrollment(userId, courseId){
    pendingEnrollments = pendingEnrollments.filter(p=>!(p.userId===userId && p.courseId===courseId));
    localStorage.setItem('pendingEnrollments',JSON.stringify(pendingEnrollments));
    renderStudents();
    updateStats();
}

/* ---------- LOGOUT ---------- */
function logout(){
    localStorage.removeItem('currentUser');
    location.href='login.html';
}

/* ---------- INITIAL RENDER ---------- */
updateStats();
renderTables();

</script>
</body>
</html>
